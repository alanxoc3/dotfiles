#!/bin/bash
# a script for encrypting & backing up my sensitive files
# requires my custom "storebackup" script to be in my dotfiles on the server

set -e # exit on error

usage() {
    echo 'USAGE: backup-to-server backup  ssh-profile local/path/to/files/or/folders...'
    echo '       backup-to-server restore ssh-profile remote/path/to/backup.cpio.age local/path/to/extraction/dir'
    exit 1
}

[ "$#" -le "3" ] && usage

: ${PA_PUBKEYS:=${XDG_CONFIG_HOME:=$HOME/.config}/pa/pubkeys}
: ${PA_PRIVKEYS:=${XDG_CONFIG_HOME:=$HOME/.config}/pa/privkeys}
: ${BACKUP_COUNT:=20}

BACKUP_COMMAND="$1"
SSH_PROFILE="$2"

if [ "$BACKUP_COMMAND" = 'backup' ]; then
    fd -I -t f '' "${@:3}" |
        cpio -o 2>/dev/null |
        age -R "$PA_PUBKEYS" |
        ssh -T "$SSH_PROFILE" 'bpath=~/backups bpostfix=.cpio.age storebackup '"$BACKUP_COUNT"
elif [ "$BACKUP_COMMAND" = 'restore' ]; then
    [ -z "$3" ] && usage
    [ -z "$4" ] && usage
    mkdir -p "$4"
    cd "$4"
    scp "$SSH_PROFILE":"$3" /dev/stdout | age -d -i "$PA_PRIVKEYS" | cpio -id --no-absolute-filenames
else
    usage
fi
